name: Build Android APK

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate project structure
        run: |
          echo "====== Validating Project Structure ======"
          
          # Check critical files
          if [ ! -f "build.gradle" ]; then
            echo "‚ùå Root build.gradle NOT FOUND"
            exit 1
          fi
          
          if [ ! -f "settings.gradle" ]; then
            echo "‚ùå settings.gradle NOT FOUND"
            exit 1
          fi
          
          if [ ! -f "app/build.gradle" ]; then
            echo "‚ùå app/build.gradle NOT FOUND"
            exit 1
          fi
          
          if [ ! -f "app/src/main/AndroidManifest.xml" ]; then
            echo "‚ùå AndroidManifest.xml NOT FOUND"
            exit 1
          fi
          
          echo "‚úÖ All critical files present"
          
          # Show structure
          echo ""
          echo "====== Project Structure ======"
          tree -L 4 || find . -type f -name "*.gradle" -o -name "AndroidManifest.xml"

      - name: Show build.gradle files content
        run: |
          echo "====== Root build.gradle ======"
          cat build.gradle
          echo ""
          echo "====== settings.gradle ======"
          cat settings.gradle
          echo ""
          echo "====== app/build.gradle ======"
          cat app/build.gradle
          echo ""
          echo "====== AndroidManifest.xml ======"
          cat app/src/main/AndroidManifest.xml

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.4

      - name: Make gradlew executable (if exists)
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            echo "‚úÖ gradlew found and made executable"
          else
            echo "‚ÑπÔ∏è gradlew not found, using gradle command"
          fi

      - name: List all available Gradle tasks
        run: |
          echo "====== Available Gradle Tasks ======"
          gradle tasks --all || echo "Failed to list tasks"

      - name: Clean build directories
        run: |
          echo "====== Cleaning Build Directories ======"
          gradle clean --stacktrace || echo "Clean failed (might be ok)"

      - name: Build Debug APK with error capture
        run: |
          echo "====== Building Debug APK ======"
          set +e
          gradle :app:assembleDebug --stacktrace --info 2>&1 | tee build_output.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "‚ùå ====== BUILD FAILED! ======"
            echo ""
            echo "====== Last 150 lines of build output: ======"
            tail -150 build_output.log
            echo ""
            echo "====== Searching for ERROR messages: ======"
            grep -i "error" build_output.log | head -50 || echo "No explicit ERROR keyword found"
            echo ""
            echo "====== Searching for FAILURE messages: ======"
            grep -i "failure\|failed" build_output.log | head -50 || echo "No FAILURE keyword found"
            exit 1
          else
            echo "‚úÖ Build completed successfully!"
          fi

      - name: Verify APK was created
        run: |
          echo "====== Checking for APK ======"
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "‚úÖ APK successfully created!"
            ls -lh app/build/outputs/apk/debug/app-debug.apk
            
            # Show APK info
            file app/build/outputs/apk/debug/app-debug.apk
            du -h app/build/outputs/apk/debug/app-debug.apk
          else
            echo "‚ùå APK NOT FOUND!"
            echo "Listing all build outputs:"
            find app/build -type f -name "*.apk" -o -name "*.aab" || echo "No APK/AAB found anywhere"
            echo ""
            echo "Checking app/build/outputs structure:"
            ls -R app/build/outputs/ || echo "No outputs directory"
            exit 1
          fi

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ParkingScanner-Debug-APK-${{ github.run_number }}
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
          retention-days: 30

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            build_output.log
            app/build/reports/
            app/build/outputs/logs/
          if-no-files-found: warn
          retention-days: 7

      - name: Build summary
        if: always()
        run: |
          echo "====== Build Summary ======"
          echo "Workflow run: #${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "‚úÖ Status: SUCCESS"
            echo "üì¶ APK Size: $(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)"
            echo "üì• Download from: Actions ‚Üí Artifacts ‚Üí ParkingScanner-Debug-APK-${{ github.run_number }}"
          else
            echo "‚ùå Status: FAILED"
            echo "üìã Check error logs above or download: Actions ‚Üí Artifacts ‚Üí build-logs-${{ github.run_number }}"
          fi

  # Job opzionale per release build
  build-release:
    name: Build Release APK (Optional)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.4

      - name: Build Release APK (unsigned)
        run: |
          echo "====== Building Release APK ======"
          gradle :app:assembleRelease --stacktrace

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ParkingScanner-Release-APK-${{ github.run_number }}
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90
